<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>MBTI职业性格测试</title>
    <link rel="stylesheet" href="/eap/static/commons/css/weui.css">
</head>
<body ontouchstart="">
<style type="text/css">


    div {
        /*关键代码*/
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }
</style>
<div class="container" id="container">
    <div class="page tabbar js_show">
        <div class="page__bd" style="height: 100%;margin-top: 10px">
            <div class="weui-tab">
                <div class="weui-cell__ft" style="margin-right: 70%;height: 20px;float:left; display:inline">
                    <p style="margin-left: 1em;color: black;">进度 <i style="font-style: normal;" id="count"></i>/<i
                            id="total"></i></p>
                </div>
                <div class="weui-slider" style="margin-left: 35%;">
                    <div class="weui-slider__inner">
                        <div style="width: 0%;" class="weui-slider__track"></div>
                        <div style="left: 0%;" class="weui-slider__handler"></div>
                    </div>
                </div>

                <a class="weui-cell weui-cell_access">
                    <div class="weui-cell__bd">
                        <p id="topic"></p>
                    </div>
                </a>
                <div id="options">
                </div>
                <div class="weui-cell">
                    <a href="javascript:;" id="forwardOne" class="syt" style="display: none;">上一题</a>
                    <div class="weui-cell__bd">
                        <a href="javascript:void(0)" class="weui-btn weui-btn_primary" id="saveBtn"
                           style="display:none;width: 25%;margin-right:1em;font-size:13px;">提交</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" src="/eap/static/commons/js/third/jquery-weui.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var type = localStorage["code"];
        var strJson = null;
        var result = new Array();
        var count = 1;
        var total = 0;
        $.post("/common/getQuestion?type=" + type, function (data) {
            if (data != null) {
                if (data.result == true) {
                    strJson = data.object;
                    total = strJson.total;
                    $("#total").html(total);
                    strJson.questions.forEach(function (obj) {
                        //初始第一个
                        if (obj.num == 1) {
                            $("#count").html(1)
                            $("#topic").html(obj.topic)
                            var present = 0;
                            $(".weui-slider__track").css("width", present + "%");
                            $(".weui-slider__handler").css("left", present + "%");
                            var $options = "";
                            obj.answer.forEach(function (opt) {
                                $options = $options + "<a data-val=" + opt.options + " class=\"cell_access_click weui-cell weui-cell_access\">\n" +
                                    "                        <div class=\"weui-cell__bd\">\n" +
                                    "                            <p>" + opt.options + "." + opt.description + "</p>\n" +
                                    "                        </div>\n" +
                                    "                    </a>"
                            })
                            $("#options").html($options);
                            count++;
                        }
                    })
                }
            }
        }, "json")


        $("div").on('click', '.cell_access_click', function () {
            $(this).siblings().children("i").remove();
            $(this).children("i").remove();
            $(this).append("<i class=\"weui-icon-success-no-circle\"></i>");

            if (count == total) {
                $("#saveBtn").css("display", "block");
                $("#saveBtn").attr("disabled", "disabled");
                $("#count").html(total)
                $(".weui-slider__track").css("width", "100%");
                $(".weui-slider__handler").css("left", "100%");
                if (result.length == total) {
                    result.pop();
                    $("#saveBtn").remove("background-color", "#d9d9d9").attr("disabled", "false");
                }
                result.push($(this).attr("data-val"));
            } else {
                var obj = strJson.questions[count - 1];
                var $options = "";
                $("#topic").html(obj.topic);
                $("#count").html(count)
                var present = (count) / total * 100;
                $(".weui-slider__track").css("width", present + "%");
                $(".weui-slider__handler").css("left", present + "%");
                obj.answer.forEach(function (opt) {
                    $options = $options + "<a data-val=" + opt.options + " class=\"cell_access_click weui-cell weui-cell_access\">\n" +
                        "                        <div class=\"weui-cell__bd\">\n" +
                        "                            <p>" + opt.options + "." + opt.description + "</p>\n" +
                        "                        </div>\n" +
                        "                    </a>"
                })
                result.push($(this).attr("data-val"));
                count++;
                $("#options").html($options);
            }
            if (count > 1) {
                $("#forwardOne").css("display", "block");
            }

        });

        $("#forwardOne").click(function () {
            $("#saveBtn").css("display", "none");
            --count;
            if (count > 0) {
                var pre = count;
                $("#count").html(count)
                var present = (count) / total * 100;
                $(".weui-slider__track").css("width", present + "%");
                $(".weui-slider__handler").css("left", present + "%");
                var obj = strJson.questions[count - 1];
                $("#topic").html(obj.topic);
                var $options = "";
                //删除最后一个
                result.pop();
                //获取上一个题的选择答案
                var preOne = result.slice(result.length - 1);
                obj.answer.forEach(function (opt) {
                    console.log(opt.options == preOne[0])
                    $options = $options + "<a data-val=" + opt.options + " class=\"cell_access_click weui-cell weui-cell_access\">\n" +
                        "                        <div class=\"weui-cell__bd\">\n" +
                        "                            <p>" + opt.options + "." + opt.description + "</p>\n" +
                        "                        </div>\n";
                    if (opt.options == preOne[0]) {
                        $options = $options + "<i class=\"weui-icon-success-no-circle\"></i>";
                    }

                    $options = $options + "                    </a>";

                })
                $("#options").html($options);
            }
            if (count == 1) {
                $("#forwardOne").css("display", "none");
            }
        })

        $("#saveBtn").click(function () {
            // $.toast("正在提交");
            $.ajax({
                type: 'POST',
                url: '/common/submitAnswer',
                data: JSON.stringify({
                    "answer": result.toString(),
                    "userName": localStorage.userName,
                    "company":localStorage.company,
                    "userPhone": localStorage.userPhone,
                    "sex":localStorage.sex,
                    "age":localStorage.age,
                    "evaType": localStorage.evaType
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function (data) {

                    if (data.result){
                        result = new Array();
                        location.href = "/eap/static/evaluation_success.html";
                    }else{
                        $.toast("提交失败");
                    }
                }
            });


        })
    });

    function sleep(numberMillis) {
        var now = new Date();
        var exitTime = now.getTime() + numberMillis;
        while (true) {
            now = new Date();
            if (now.getTime() > exitTime) return;
        }
    }

</script>
</html>